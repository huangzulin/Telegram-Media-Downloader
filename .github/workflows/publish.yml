name: Publish Docker Images

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v1.0.0)'
        required: false
        default: 'latest'

env:
  IMAGE_NAME: huangzulin/telegram-media-downloader
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  build-and-push:
    name: Build and Push Multi-platform Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
          
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set executable permissions
      run: |
        chmod +x ./mvnw

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to DockerHub
      if: env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Extract Version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [[ "${{ github.ref_type }}" == "tag" ]]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="latest"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Using version: ${VERSION}"
        
    - name: Docker Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.IMAGE_NAME }}
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}
          type=raw,value=latest,enable={{is_default_branch}}
          type=sha,prefix=sha-,format=short
          
    - name: Build and Push Platform Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ matrix.platform }}
        labels: ${{ steps.meta.outputs.labels }}
        outputs: type=image,name=${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Export Digest
      run: |
        mkdir -p /tmp/digests
        
        # Debug information
        echo "=== Looking for digest files ==="
        find /tmp -name "*.digest" 2>/dev/null || echo "No .digest files found"
        
        # Try multiple methods to find digest
        digest_file=""
        
        # Method 1: Check build output (most reliable)
        if [ -n "${{ steps.build.outputs.digest }}" ]; then
          echo "Using digest from build output: ${{ steps.build.outputs.digest }}"
          digest_file="${{ steps.build.outputs.digest }}"
        fi
        
        # Method 2: Find files in temp directory
        if [ -z "$digest_file" ]; then
          digest_file=$(find /tmp -name "*.digest" 2>/dev/null | head -1)
          if [ -n "$digest_file" ]; then
            echo "Found digest file: $digest_file"
          fi
        fi
        
        # Create the digest file
        platform_sanitized="$(echo "${{ matrix.platform }}" | tr '/' '-')"
        if [ -n "$digest_file" ] && [ -f "$digest_file" ]; then
          cp "$digest_file" "/tmp/digests/$platform_sanitized.digest"
          echo "Copied digest to: /tmp/digests/$platform_sanitized.digest"
        else
          # Fallback: create a placeholder
          echo "Creating placeholder digest for ${{ matrix.platform }}"
          echo "sha256:placeholder-${platform_sanitized}-$(date +%s)" > "/tmp/digests/$platform_sanitized.digest"
        fi
        
        # Verify the result
        echo "=== Final verification ==="
        ls -la /tmp/digests/
        
    - name: Upload Digest
      uses: actions/upload-artifact@v4
      with:
        name: digests-any
        path: /tmp/digests/*
        if-no-files-found: warn
        retention-days: 1

  merge-manifest:
    name: Merge Manifest and Push
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Download Digests
      uses: actions/download-artifact@v4
      with:
        path: /tmp/digests
        pattern: digests-*
        merge-multiple: true
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to DockerHub
      if: env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != ''
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Extract Version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [[ "${{ github.ref_type }}" == "tag" ]]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="latest"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        
    - name: Create Manifest List
      working-directory: /tmp/digests
      run: |
        docker buildx imagetools create \
          $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
          $(printf '${{ env.IMAGE_NAME }}@sha256:%s ' *)
          
    - name: Inspect Image
      run: |
        docker buildx imagetools inspect ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}