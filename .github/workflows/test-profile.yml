name: Test Maven Profile Activation

on:
  workflow_dispatch:
  push:
    branches: [ test-profile ]

jobs:
  test-profiles:
    name: Test Profile Activation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set executable permissions
      run: |
        chmod +x ./mvnw
        chmod +x ./test_profile_activation.sh
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Test Profile Activation Script
      run: |
        echo "=== è¿è¡ŒProfileæ¿€æ´»æµ‹è¯•è„šæœ¬ ==="
        ./test_profile_activation.sh
        
    - name: Detailed Maven Analysis
      run: |
        echo "=== è¯¦ç»†Mavenåˆ†æ ==="
        
        echo "1. ç³»ç»Ÿå±æ€§æ£€æŸ¥:"
        ./mvnw help:system | grep -E "(os\.name|os\.arch|os\.version)"
        
        echo "2. Profileè¯¦ç»†ä¿¡æ¯:"
        ./mvnw help:all-profiles
        
        echo "3. ä¾èµ–è§£ææµ‹è¯•:"
        ./mvnw dependency:resolve -P linux-x64
        
        echo "4. æ„å»ºå¹¶æ£€æŸ¥ä¾èµ–:"
        ./mvnw clean compile -P linux-x64 -DskipTests
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥ä¾èµ–:"
        ./mvnw dependency:list | grep tdlight
        
    - name: Validate TDLight Integration
      run: |
        echo "=== éªŒè¯TDLighté›†æˆ ==="
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†åŒ…å«tdlightçš„JAR
        if [ -f "target/tmd-1.0.jar" ]; then
          echo "JARåŒ…å¤§å°: $(du -h target/tmd-1.0.jar)"
          echo "TDLightç›¸å…³æ–‡ä»¶:"
          jar -tf target/tmd-1.0.jar | grep -i tdlight || echo "âš ï¸  JARä¸­æœªæ‰¾åˆ°TDLightæ–‡ä»¶"
        else
          echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„JARåŒ…"
        fi
        
        # å°è¯•åŸºæœ¬çš„Javaè¿è¡Œæµ‹è¯•
        echo "å°è¯•åŸºæœ¬è¿è¡Œæµ‹è¯•:"
        timeout 5s java -cp target/classes it.tdlight.Init 2>&1 || echo "é¢„æœŸçš„åˆå§‹åŒ–é”™è¯¯ï¼ˆæ­£å¸¸ï¼‰"
        
    - name: Create Test Report
      run: |
        echo "=== æµ‹è¯•æŠ¥å‘Š ==="
        echo "æµ‹è¯•æ—¶é—´: $(date)"
        echo "Runner OS: ${{ runner.os }}"
        echo "Java Version: $(java -version 2>&1 | head -1)"
        echo "Maven Version: $(./mvnw --version | head -1)"
        
        # æ€»ç»“ç»“æœ
        echo ""
        echo "ğŸ“‹ æµ‹è¯•ç»“è®º:"
        if ./mvnw dependency:tree -P linux-x64 | grep -q "tdlight"; then
          echo "âœ… TDLightä¾èµ–æ­£ç¡®æ¿€æ´»"
        else
          echo "âŒ TDLightä¾èµ–æœªæ­£ç¡®æ¿€æ´»"
        fi