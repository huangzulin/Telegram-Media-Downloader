name: Release Automation

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up file permissions
      run: |
        chmod +x ./mvnw
        ls -la ./mvnw
        
    - name: Extract tag information
      id: tag_info
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}
        echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        
    - name: Get previous tag
      id: previous_tag
      run: |
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        echo "previous_tag=${PREVIOUS_TAG}" >> $GITHUB_OUTPUT
        
    - name: Generate release notes
      id: release_notes
      run: |
        TAG_NAME=${{ steps.tag_info.outputs.tag_name }}
        PREVIOUS_TAG=${{ steps.previous_tag.outputs.previous_tag }}
        
        if [[ -n "$PREVIOUS_TAG" ]]; then
          COMMITS=$(git log ${PREVIOUS_TAG}..${TAG_NAME} --pretty=format:"- %s (%h)" --no-merges)
        else
          COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        RELEASE_NOTES=$(cat <<EOF
        ## ðŸŽ‰ Telegram Media Downloader ${TAG_NAME}
        
        ### ðŸ“¦ What's New
        
        ${COMMITS}
        
        ### ðŸ³ Docker Images
        
        Docker images are automatically built and published to GitHub Container Registry:
        
        \`\`\`bash
        docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${TAG_NAME}
        docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
        \`\`\`
        
        ### ðŸš€ Quick Start
        
        \`\`\`bash
        # Using Docker
        docker run -d \\
          --name tmd \\
          -p 3222:3222 \\
          -v ./data:/app/data \\
          -v ./downloads:/app/downloads \\
          -v ./logs:/app/logs \\
          -e APP_ID=your_app_id \\
          -e API_HASH=your_api_hash \\
          ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${TAG_NAME}
        
        # Using Docker Compose
        wget https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml
        docker-compose up -d
        \`\`\`
        
        ### ðŸ“š Documentation
        
        For detailed documentation, please visit:
        - [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        - [Configuration Guide](https://github.com/${{ github.repository }}/blob/main/README.md#%EF%B8%8F-%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9)
        
        ### âš ï¸ Breaking Changes
        
        _No breaking changes in this release._
        
        ### ðŸ› Bug Fixes
        
        _No bug fixes in this release._
        
        ### ðŸ†• Features
        
        _No new features in this release._
        EOF
        )
        
        echo "release_body<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_info.outputs.tag_name }}
        release_name: Telegram Media Downloader ${{ steps.tag_info.outputs.tag_name }}
        body: ${{ steps.release_notes.outputs.release_body }}
        draft: false
        prerelease: false
        
    - name: Build application JAR
      run: |
        ./mvnw clean package -DskipTests -B
        
    - name: Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./target/tmd-${{ steps.tag_info.outputs.version }}.jar
        asset_name: telegram-media-downloader-${{ steps.tag_info.outputs.version }}.jar
        asset_content_type: application/java-archive

  update-documentation:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: create-release
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Update version in README
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        VERSION=${TAG_NAME#v}
        
        # Update Docker image tags in README
        sed -i "s/telegram-media-downloader:latest/telegram-media-downloader:${TAG_NAME}/g" README.md
        sed -i "s/telegram-media-downloader:v[0-9.]*/telegram-media-downloader:${TAG_NAME}/g" README.md
        
    - name: Commit documentation updates
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "docs: update documentation for release ${GITHUB_REF#refs/tags/}"
        file_pattern: README.md